import streamlit as st
import pandas as pd
import io

st.set_page_config(page_title="‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á", layout="wide")

# -----------------------------
# Factor tables (‡∏¢‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠)
# -----------------------------

# Asphalt factors
X1_OPTIONS = {
    "AC + ‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å": 0.00,
    "Surface Treatment + ‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å": 0.50,
    "AC + Soil Aggregate": 0.50,
    "Surface Treatment + Soil Aggregate": 1.00,
}

X2_OPTIONS = {
    "CBR ‚â§ 2": 1.00,
    "CBR = 3": 0.75,
    "CBR = 4": 0.50,
    "CBR = 5": 0.25,
    "CBR ‚â• 6": 0.00,
}

X3_OPTIONS = {
    "‚â§ 500": 0.00,
    "501‚Äì600": 0.04,
    "601‚Äì700": 0.08,
    "701‚Äì800": 0.12,
    "801‚Äì900": 0.16,
    "901‚Äì1000": 0.20,
    "1001‚Äì1100": 0.24,
    "1101‚Äì1200": 0.29,
    "1201‚Äì1300": 0.33,
    "1301‚Äì1400": 0.37,
    "1401‚Äì1500": 0.41,
    "1501‚Äì1600": 0.45,
    "1601‚Äì1700": 0.49,
    "1701‚Äì1800": 0.53,
    "1801‚Äì1900": 0.57,
    "1901‚Äì2000": 0.61,
    "2001‚Äì2200": 0.69,
    "2201‚Äì2400": 0.78,
    "2401‚Äì2600": 0.86,
    "2601‚Äì2800": 0.94,
    "2801‚Äì3000": 1.02,
    "3001‚Äì3300": 1.14,
    "3301‚Äì3600": 1.27,
    "3601‚Äì3900": 1.37,
    "3901‚Äì4200": 1.51,
    "4201‚Äì4500": 1.64,
    "4501‚Äì4800": 1.76,
    "4801‚Äì5100": 1.88,
    "5101‚Äì5400": 2.00,
    "5401‚Äì5700": 2.13,
    "‚â• 5701": 2.25,
}

X5_MAP = {5.0: 0.00, 5.5: 0.02, 6.0: 0.05, 6.5: 0.10, 7.0: 0.19}
X6_MAP = {"‡∏£‡∏≤‡∏ö": 0.00, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô": 0.02, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤": 0.04, "‡πÄ‡∏Ç‡∏≤": 0.07}

Y2_SHOULDER_LATERITE = {
    0.50: 0.00,
    1.00: 0.00,
    1.50: 0.00,
    1.75: 0.00,
    2.00: 0.00,
    2.25: 0.02,
    2.50: 0.05,
}

# Laterite factors
A1_OPTIONS = {
    "‚â§ 100": 0.00,
    "101‚Äì150": 0.13,
    "151‚Äì200": 0.24,
    "201‚Äì250": 0.36,
    "251‚Äì300": 0.47,
    "301‚Äì350": 0.59,
    "351‚Äì400": 0.71,
    "‚â• 401": 0.95,
}

A3_MAP = {6.0: 0.00, 7.0: 0.17, 8.0: 0.33, 9.0: 0.55, 10.0: 0.67, 11.0: 0.84, 12.0: 1.00}
B1_MAP = {20: 0.00, 30: 0.08, 40: 0.13, 50: 0.21, 60: 0.24}
B2_MAP = {"‡∏£‡∏≤‡∏ö": 0.05, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô": 0.13, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤": 0.22, "‡πÄ‡∏Ç‡∏≤": 0.32}
B3_MAP = {"‡∏£‡∏≤‡∏ö": 0.00, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô": 0.40, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤": 0.60, "‡πÄ‡∏Ç‡∏≤": 0.80}

# Concrete factors (‡∏¢‡πà‡∏≠)
Z1_OPTIONS = {
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 1 (‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ~1%)": 0.00,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 2 (~2%)": 0.25,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 3 (~3%)": 0.50,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 4 (~4%)": 0.75,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 5 (~5%)": 1.00,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 6 (~6%)": 1.30,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 7 (~7%)": 1.60,
    "‡∏î‡∏±‡∏ä‡∏ô‡∏µ 8 (~8‚Äì10%)": 2.00,
}

Z2_OPTIONS = {
    "CBR ‚â§ 2": 1.00,
    "CBR = 3": 0.75,
    "CBR = 4": 0.50,
    "CBR = 5": 0.25,
    "CBR ‚â• 6": 0.00,
}

Z3_OPTIONS = {
    "‚â§ 1000": 0.00,
    "1001‚Äì2000": 0.25,
    "2001‚Äì3000": 0.50,
    "3001‚Äì4000": 0.75,
    "4001‚Äì5000": 1.00,
    "‚â• 5001": 1.25,
}

Z4_MAP = {5.0: 0.00, 6.0: 0.10, 7.0: 0.17, 8.0: 0.25}

Y3_MAP = {"‡∏£‡∏≤‡∏ö": 0.00, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô": 0.24, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤": 0.36, "‡πÄ‡∏Ç‡∏≤": 0.48}
Y4_MAP = {"‡∏£‡∏≤‡∏ö": 0.00, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô": 0.24, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤": 0.36, "‡πÄ‡∏Ç‡∏≤": 0.48}
Y6_MAP = {"‡∏£‡∏≤‡∏ö": 0.00, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô": 0.04, "‡∏•‡∏π‡∏Å‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤": 0.08, "‡πÄ‡∏Ç‡∏≤": 0.12}

# -----------------------------
# Core calculation functions
# -----------------------------

def calc_asphalt(f):
    return 1 + 0.5 * sum([
        f["X1"], f["X2"], f["X3"], f["X4"], f["X5"], f["X6"],
        f["Y1"], f["Y2"], f["Y3"], f["Y4"], f["Y5"], f["Y6"],
    ])

def calc_laterite(f):
    return 1 + 0.70 * (f["A1"] + f["A2"] + f["A3"]) + 0.30 * (f["B1"] + f["B2"] + f["B3"] + f["B4"])

def calc_concrete(f):
    return 1 + 0.5 * sum([
        f["Z1"], f["Z2"], f["Z3"], f["Z4"],
        f["Y1"], f["Y2"], f["Y3"], f["Y4"], f["Y5"], f["Y6"],
    ])

def calc_budget(K, distance, Km, Na):
    workload = K * distance
    budget = workload * Km * Na
    return workload, budget

# -----------------------------
# Session state
# -----------------------------

if "records" not in st.session_state:
    st.session_state["records"] = []

# -----------------------------
# UI ‚Äì Global inputs
# -----------------------------

st.title("üìò ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á")

with st.sidebar:
    st.header("‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á")
    route_id = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç/‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á", "")
    distance = st.number_input("‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.)", min_value=0.0, step=0.001, value=1.000)
    Km = st.number_input("‡∏Ñ‡πà‡∏≤ Km ‡∏ß‡∏±‡∏™‡∏î‡∏∏", min_value=0.0, value=1.00)
    Na = st.number_input("‡∏Ñ‡πà‡∏≤‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Na/Ns/Nc) ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢", min_value=0.0, value=17000.0)

surface = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á", ["‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ó‡πå", "‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏á", "‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï"])

st.markdown("---")

# -----------------------------
# Asphalt UI
# -----------------------------
if surface == "‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ó‡πå":
    st.subheader("‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ó‡πå")

    col1, col2 = st.columns(2)

    with col1:
        x1_key = st.selectbox("X1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á + ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏≤‡∏á", list(X1_OPTIONS.keys()))
        X1 = X1_OPTIONS[x1_key]

        x2_key = st.selectbox("X2 ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏î‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏° (CBR)", list(X2_OPTIONS.keys()))
        X2 = X2_OPTIONS[x2_key]

        x3_key = st.selectbox("X3 ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏à‡∏£‡∏≤‡∏à‡∏£ (‡∏Ñ‡∏±‡∏ô/‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ 2 ‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏£‡∏≤‡∏à‡∏£)", list(X3_OPTIONS.keys()))
        X3 = X3_OPTIONS[x3_key]

        age = st.slider("‡∏≠‡∏≤‡∏¢‡∏∏‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏õ‡∏µ)", 0, 20, 5)
        # ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á: 0‚Äì3 = 0, 4‚Äì12 ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 0.2
        if age <= 3:
            X4 = 0.0
        else:
            step = min(age, 12) - 3
            X4 = 0.2 * step

    with col2:
        width = st.select_slider("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£)", options=[5.0, 5.5, 6.0, 6.5, 7.0], value=6.5)
        X5 = X5_MAP[width]

        topo = st.selectbox("‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(X6_MAP.keys()))
        X6 = X6_MAP[topo]

        right_of_way = st.number_input("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡∏ï‡∏£)", value=40.0)
        if right_of_way <= 40:
            Y1 = 0.0
        elif right_of_way <= 60:
            Y1 = 0.10
        elif right_of_way <= 80:
            Y1 = 0.20
        else:
            Y1 = 0.30

        shoulder_w = st.select_slider("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏á (‡πÄ‡∏°‡∏ï‡∏£/‡∏Ç‡πâ‡∏≤‡∏á)", options=[0.5, 1.0, 1.5, 1.75, 2.0, 2.25, 2.5], value=2.0)
        Y2 = Y2_SHOULDER_LATERITE[shoulder_w]

    # ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå / ‡∏ó‡πà‡∏≠ / ‡∏™‡∏∞‡∏û‡∏≤‡∏ô / ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î
    col3, col4 = st.columns(2)
    with col3:
        topo_y3 = st.selectbox("Y3 ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(Y3_MAP.keys()))
        Y3 = Y3_MAP[topo_y3]

        topo_y4 = st.selectbox("Y4 ‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(Y4_MAP.keys()))
        Y4 = Y4_MAP[topo_y4]

    with col4:
        bridge_len = st.number_input("Y5 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏°./‡∏Å‡∏°.)", min_value=0.0, value=0.0)
        if bridge_len <= 20:
            Y5 = 0.0
        elif bridge_len <= 25:
            Y5 = 0.02
        elif bridge_len <= 30:
            Y5 = 0.04
        else:
            Y5 = 0.06

        topo_y6 = st.selectbox("Y6 ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(Y6_MAP.keys()))
        Y6 = Y6_MAP[topo_y6]

    if st.button("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏ß‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ó‡πå"):
        f = dict(
            X1=X1, X2=X2, X3=X3, X4=X4, X5=X5, X6=X6,
            Y1=Y1, Y2=Y2, Y3=Y3, Y4=Y4, Y5=Y5, Y6=Y6,
        )
        K = calc_asphalt(f)
        workload, budget = calc_budget(K, distance, Km, Na)

        st.success(f"K ‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á = {K:.3f}")
        st.info(f"‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô = {workload:.3f} ‡∏´‡∏ô‡πà‡∏ß‡∏¢")
        st.warning(f"‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì = {budget:,.2f} ‡∏ö‡∏≤‡∏ó")

        st.session_state["records"].append({
            "‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á": route_id,
            "‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á": "‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ó‡πå",
            "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‡∏Å‡∏°.": distance,
            "K": round(K, 3),
            "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢": round(workload, 3),
            "Km": Km,
            "Na/Ns/Nc": Na,
            "‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏≤‡∏ó": round(budget, 2),
        })

# -----------------------------
# Laterite UI
# -----------------------------
elif surface == "‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏á":
    st.subheader("‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏á")

    col1, col2 = st.columns(2)

    with col1:
        a1_key = st.selectbox("A1 ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏à‡∏£‡∏≤‡∏à‡∏£ (‡∏Ñ‡∏±‡∏ô/‡∏ß‡∏±‡∏ô)", list(A1_OPTIONS.keys()))
        A1 = A1_OPTIONS[a1_key]

        # A2 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ‚Äì ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô 0
        A2 = st.number_input("A2 ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏•‡∏°‡∏ü‡πâ‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ä‡πâ 0)", value=0.0)

        a3_w = st.select_slider("A3 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô‡∏ó‡∏≤‡∏á (‡∏ú‡∏¥‡∏ß+‡πÑ‡∏´‡∏•‡πà) ‡πÄ‡∏°‡∏ï‡∏£", options=[6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0], value=7.0)
        A3 = A3_MAP[a3_w]

    with col2:
        b1_w = st.select_slider("B1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡∏ï‡∏£)", options=[20, 30, 40, 50, 60], value=30)
        B1 = B1_MAP[b1_w]

        topo_b2 = st.selectbox("B2 ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(B2_MAP.keys()))
        B2 = B2_MAP[topo_b2]

        topo_b3 = st.selectbox("B3 ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(B3_MAP.keys()))
        B3 = B3_MAP[topo_b3]

        bridge_len = st.number_input("B4 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏°./‡∏Å‡∏°.)", min_value=0.0, value=0.0)
        if bridge_len <= 20:
            B4 = 0.02
        elif bridge_len <= 21:
            B4 = 0.03
        elif bridge_len <= 22:
            B4 = 0.10
        elif bridge_len <= 23:
            B4 = 0.15
        elif bridge_len <= 24:
            B4 = 0.20
        elif bridge_len <= 25:
            B4 = 0.25
        elif bridge_len <= 26:
            B4 = 0.30
        elif bridge_len <= 27:
            B4 = 0.35
        elif bridge_len <= 28:
            B4 = 0.40
        elif bridge_len <= 29:
            B4 = 0.45
        else:
            B4 = 0.50

    if st.button("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏ß‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏á"):
        f = dict(A1=A1, A2=A2, A3=A3, B1=B1, B2=B2, B3=B3, B4=B4)
        K = calc_laterite(f)
        workload, budget = calc_budget(K, distance, Km, Na)

        st.success(f"K ‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á = {K:.3f}")
        st.info(f"‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô = {workload:.3f} ‡∏´‡∏ô‡πà‡∏ß‡∏¢")
        st.warning(f"‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì = {budget:,.2f} ‡∏ö‡∏≤‡∏ó")

        st.session_state["records"].append({
            "‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á": route_id,
            "‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á": "‡∏•‡∏π‡∏Å‡∏£‡∏±‡∏á",
            "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‡∏Å‡∏°.": distance,
            "K": round(K, 3),
            "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢": round(workload, 3),
            "Km": Km,
            "Na/Ns/Nc": Na,
            "‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏≤‡∏ó": round(budget, 2),
        })

# -----------------------------
# Concrete UI
# -----------------------------
elif surface == "‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï":
    st.subheader("‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï")

    col1, col2 = st.columns(2)

    with col1:
        z1_key = st.selectbox("Z1 ‡∏™‡∏†‡∏≤‡∏û‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á (‡∏î‡∏±‡∏ä‡∏ô‡∏µ)", list(Z1_OPTIONS.keys()))
        Z1 = Z1_OPTIONS[z1_key]

        z2_key = st.selectbox("Z2 ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏î‡∏¥‡∏ô‡∏Ñ‡∏±‡∏ô‡∏ó‡∏≤‡∏á (CBR)", list(Z2_OPTIONS.keys()))
        Z2 = Z2_OPTIONS[z2_key]

        z3_key = st.selectbox("Z3 ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏à‡∏£‡∏≤‡∏à‡∏£ (‡∏Ñ‡∏±‡∏ô/‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ 2 ‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏£‡∏≤‡∏à‡∏£)", list(Z3_OPTIONS.keys()))
        Z3 = Z3_OPTIONS[z3_key]

        z4_w = st.select_slider("Z4 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£)", options=[5.0, 6.0, 7.0, 8.0], value=7.0)
        Z4 = Z4_MAP[z4_w]

    with col2:
        right_of_way = st.number_input("Y1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡∏ï‡∏£)", value=40.0)
        if right_of_way <= 40:
            Y1 = 0.0
        elif right_of_way <= 60:
            Y1 = 0.10
        elif right_of_way <= 80:
            Y1 = 0.20
        else:
            Y1 = 0.30

        shoulder_w = st.select_slider("Y2 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏≤‡∏á/‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£/‡∏Ç‡πâ‡∏≤‡∏á)", options=[0.5, 1.0, 1.5, 2.0, 2.5], value=2.0)
        # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏™‡πÄ‡∏Å‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏á
        Y2 = 0.00 if shoulder_w <= 2.0 else 0.20

        topo_y3 = st.selectbox("Y3 ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(Y3_MAP.keys()))
        Y3 = Y3_MAP[topo_y3]

        topo_y4 = st.selectbox("Y4 ‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(Y4_MAP.keys()))
        Y4 = Y4_MAP[topo_y4]

        bridge_len = st.number_input("Y5 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏°./‡∏Å‡∏°.)", min_value=0.0, value=0.0)
        if bridge_len <= 20:
            Y5 = 0.0
        elif bridge_len <= 25:
            Y5 = 0.02
        elif bridge_len <= 30:
            Y5 = 0.04
        else:
            Y5 = 0.06

        topo_y6 = st.selectbox("Y6 ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ‚Äì ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®", list(Y6_MAP.keys()))
        Y6 = Y6_MAP[topo_y6]

    if st.button("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏¥‡∏ß‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï"):
        f = dict(
            Z1=Z1, Z2=Z2, Z3=Z3, Z4=Z4,
            Y1=Y1, Y2=Y2, Y3=Y3, Y4=Y4, Y5=Y5, Y6=Y6,
        )
        K = calc_concrete(f)
        workload, budget = calc_budget(K, distance, Km, Na)

        st.success(f"K ‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á = {K:.3f}")
        st.info(f"‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô = {workload:.3f} ‡∏´‡∏ô‡πà‡∏ß‡∏¢")
        st.warning(f"‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì = {budget:,.2f} ‡∏ö‡∏≤‡∏ó")

        st.session_state["records"].append({
            "‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á": route_id,
            "‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á": "‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï",
            "‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‡∏Å‡∏°.": distance,
            "K": round(K, 3),
            "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢": round(workload, 3),
            "Km": Km,
            "Na/Ns/Nc": Na,
            "‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏≤‡∏ó": round(budget, 2),
        })

# -----------------------------
# Summary & Export
# -----------------------------

st.markdown("---")
st.subheader("‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á")

if st.session_state["records"]:
    df = pd.DataFrame(st.session_state["records"])
    st.dataframe(df, use_container_width=True)

    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine="xlsxwriter") as writer:
        df.to_excel(writer, index=False, sheet_name="Maintenance")
    st.download_button(
        label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel",
        data=buffer,
        file_name="maintenance_calculation.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    )
else:
    st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
